<!DOCTYPE html>
<html>
<head>
  <title>Service Diagnostics</title>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAH-uLcDZZOF_h0qA6-WzQ39Z9jMvZJ62k",
      authDomain: "formgenai-4545.firebaseapp.com",
      projectId: "formgenai-4545",
      storageBucket: "formgenai-4545.firebasestorage.app",
      messagingSenderId: "422469818893",
      appId: "1:422469818893:web:3daca9f02354ce53a0d6cd"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    async function diagnoseService() {
      const serviceId = 'w9rq4zgEiihA17ZNjhSg';
      const output = document.getElementById('output');
      
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          output.innerHTML = '<p style="color: red;">‚ùå Not logged in.</p>';
          output.innerHTML += '<p><a href="/login" style="color: blue; font-weight: bold;">‚Üí Click here to log in</a></p>';
          output.innerHTML += '<p style="color: gray; font-size: 0.9em;">After logging in, return to this page.</p>';
          return;
        }

        output.innerHTML = '<p>üîç Checking service and user data...</p>';
        
        try {
          // Check user profile
          output.innerHTML += `<h3>üë§ Current User</h3>`;
          output.innerHTML += `<p>UID: ${user.uid}</p>`;
          output.innerHTML += `<p>Email: ${user.email}</p>`;
          
          const profileRef = doc(db, 'users', user.uid);
          const profileSnap = await getDoc(profileRef);
          
          if (profileSnap.exists()) {
            const profile = profileSnap.data();
            output.innerHTML += `<p>Role: ${profile.role || '‚ùå MISSING'}</p>`;
            output.innerHTML += `<p>Is Lawyer: ${profile.isLawyer ? '‚úÖ' : '‚ùå'}</p>`;
          } else {
            output.innerHTML += `<p style="color: orange;">‚ö†Ô∏è User profile not found in database!</p>`;
          }
          
          // Check service
          output.innerHTML += `<h3>üì¶ Service: ${serviceId}</h3>`;
          
          const serviceRef = doc(db, 'services', serviceId);
          const serviceSnap = await getDoc(serviceRef);
          
          if (!serviceSnap.exists()) {
            output.innerHTML += `<p style="color: red;">‚ùå Service does not exist</p>`;
            return;
          }
          
          const serviceData = serviceSnap.data();
          output.innerHTML += `<p>Name: ${serviceData.name || 'Unnamed'}</p>`;
          output.innerHTML += `<p>Created By: ${serviceData.createdBy || '‚ùå MISSING (needs migration)'}</p>`;
          output.innerHTML += `<p>Created At: ${serviceData.createdAt?.toDate?.() || 'Unknown'}</p>`;
          
          if (!serviceData.createdBy) {
            output.innerHTML += `<p style="color: orange;">‚ö†Ô∏è This service needs migration!</p>`;
            output.innerHTML += `<p><a href="/migrate.html" style="color: green; font-weight: bold;">üîß Click here to migrate</a></p>`;
          } else if (serviceData.createdBy === user.uid) {
            output.innerHTML += `<p style="color: green;">‚úÖ You own this service!</p>`;
          } else {
            output.innerHTML += `<p style="color: red;">‚ùå This service belongs to: ${serviceData.createdBy}</p>`;
          }
          
        } catch (error) {
          output.innerHTML += `<h3 style="color: red;">‚ùå Error</h3>`;
          output.innerHTML += `<p>Code: ${error.code}</p>`;
          output.innerHTML += `<p>Message: ${error.message}</p>`;
          
          if (error.code === 'permission-denied') {
            output.innerHTML += `<p style="color: red; font-weight: bold;">üîí Security rules are blocking access!</p>`;
            output.innerHTML += `<p>Possible reasons:</p>`;
            output.innerHTML += `<ul>
              <li>Service has createdBy field for a different user</li>
              <li>Your user role is not set correctly</li>
              <li>Security rules not properly deployed</li>
            </ul>`;
          }
        }
      });
    }

    window.addEventListener('load', diagnoseService);
  </script>
</head>
<body style="font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto;">
  <h1>üîç Service Diagnostics</h1>
  <p>Checking service: <code>w9rq4zgEiihA17ZNjhSg</code></p>
  <div id="output" style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin-top: 20px;">
    <p>Loading...</p>
  </div>
</body>
</html>
